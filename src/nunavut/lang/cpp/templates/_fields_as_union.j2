{#-
 # Copyright 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 # Copyright (C) 2021  UAVCAN Development Team  <uavcan.org>
 # This software is distributed under the terms of the MIT License.
#}
    class VariantType final
    {
    public:
        VariantType()
            : tag_(0)
            , internal_union_value_()
        {}

        //
        // Rule of Five.
        //
        VariantType(const VariantType&) = delete;
        VariantType& operator=(const VariantType&) = delete;
        VariantType(VariantType&&) = delete;
        VariantType& operator=(VariantType&&) = delete;

        ~VariantType()
        {
            destroy_current();
        }

        template< std::size_t I, class...Args > T& emplace(const T&& v);

        template< std::size_t I, class...Args > T& emplace(const T& v);

        template< class T >
        static constexpr bool holds_alternative( const {{ composite_type | short_reference_name }}::VariantType& v ) noexcept;

        template< class T>
        static constexpr const T* get_if(const {{ composite_type | short_reference_name }}::VariantType* v) noexcept;

        template< class T>
        static constexpr T* get_if({{ composite_type | short_reference_name }}::VariantType* v) noexcept;

        struct IndexOf final
        {
            IndexOf() = delete;
{%- for field in composite_type.fields_except_padding %}
            static constexpr const std::size_t {{ field.name | id }} = {{ loop.index0 }}U;
{%- endfor %}
        };

    private:
        void destroy_current()
        {
{%- for field in composite_type.fields_except_padding if field is not PrimitiveType %}
            {% if not loop.first %}else {% endif %}if (tag_ == {{ loop.index0 }})
            {
                if (!std::is_trivially_destructible<{{ field.data_type | declaration }}>::value)
                {
                    reinterpret_cast<{{ field.data_type | declaration }}*>(&internal_union_value_.{{ field.name | id }})->{{ field.data_type | destructor_name }}();
                }
            }
{%- endfor %}
        }

        {{ composite_type.tag_field_type | declaration }} tag_;

        union
        {
{%- for field in composite_type.fields_except_padding %}
            {{ field.doc | block_comment('cpp-doxygen', 12, 120) }}
            std::aligned_storage<sizeof({{ field.data_type | declaration }}), alignof({{ field.data_type | declaration }})>::type {{ field.name | id }};
{%- endfor %}
        } internal_union_value_;

    };

    VariantType union_value;
