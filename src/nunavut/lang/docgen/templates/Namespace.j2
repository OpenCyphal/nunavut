{% macro generate_type_info(t, attr_name, nested=False) %}
{% set type_tag_id = t | tag_id %}
{% if nested %}
{% set type_tag_id = type_tag_id | add_uuid %}
{% endif %}
<p data-toggle="tooltip" data-placement="top" title="{{ t | tooltip }}">
<a
      data-bs-toggle="collapse"
      href="#{{ type_tag_id }}"
      role="button"
      aria-expanded="false"
      aria-controls="{{ type_tag_id }}"
      >+</a>
{% if not t | is_array %}
{% if nested %}
<a href="{{ t | url_from_type }}">
{{ t.full_name }} (v{{t.version[0]}}.{{t.version[1]}}) {{ attr_name }}
</a>
{% else %}
{{ t.full_name }} (v{{t.version[0]}}.{{t.version[1]}}) {{ attr_name }}
{% endif %}
{% if not t | is_service %}
<span style="color: green">[extent {{ t | extent }} bytes]</span>
{% else %}
<span style="color: blue">[service]</span>
{% endif %}
{% if t.has_fixed_port_id %}
<span style="color: orange">[fixed port-ID {{ t.fixed_port_id }}]</span>
{% endif %}
{% else %}
{{ t }}
{% endif %}
</p>
<div class="collapse" id="{{ type_tag_id }}" style="padding-left: 1rem; border-left: 1px solid #AAA;">
    {% if t | is_array %}
    {% if t.element_type | is_composite %}
    {{ generate_type_info(t.element_type, "", True) }}
    {% else %}
    <p class="mb-0">{{ t.element_type }}</p>
    {% endif %}
    {% else %}
    {% if t.doc %}
    <pre>{{ t.doc }}</pre>
    {% endif %}
    {% if t.attributes | length == 0 %}
    <p>(data type is empty)</p>
    {% else %}
    {% for attr in t.attributes %}
    {% if attr.data_type | is_array %}
    {{ generate_type_info(attr.data_type, "", True) }}
    {% elif attr.data_type | is_composite %}
    {{ generate_type_info(attr.data_type, attr.name, True) }}
    {% else %}
    <p class="mb-0">
    {{ attr }}
    {% if attr | is_field %}
    <span style="color: green">[extent {{ attr.data_type | extent }} bytes]</span>
    {% endif %}
    </p>
    {% endif %}
    <pre>{{ attr.doc }}</pre>
    {% endfor %}
    {% endif %}
    {% endif %}
</div>
{% endmacro %}

{% macro generate_namespace_info(t) %}
<p>
<a
      data-bs-toggle="collapse"
      href="#{{ t.full_name.replace(".", "_") }}"
      role="button"
      aria-expanded="false"
      aria-controls="{{ t.full_name.replace(".", "_") }}"
      >+</a>
{{ t.full_name }}
</p>
<div class="collapse" id="{{ t.full_name.replace(".", "_") }}" style="padding-left: 1rem; border-left: 1px solid #AAA;">
    {% for type, _ in t.get_nested_types() %}
    {{ generate_type_info(type, "") }}
    {% endfor %}
    {% for type in t.get_nested_namespaces() %}
    {{ generate_namespace_info(type) }}
    {% endfor %}
</div>
{% endmacro %}

<!DOCTYPE html>
<html>
    <head>
        <title>{{ T.full_name }}</title>
        <style>
        .row {
            display: flex;
            flex-direction: row;
        }

        .py-2 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        pre {
            text-overflow: wrap !important;
        }

        .highlight {
            background-color: yellow;
            transition: background-color 200ms;
        }

        </style>
        <!-- Bootstrap-->
        <style>
        {% include "assets/bootstrap.min.css" %}
        </style>
        <script>
        {% include "assets/bootstrap.bundle.min.js" %}
        </script>
    </head>
    <body class="font-monospace p-5">
        <h2>Documentation for namespace {{ T }}</h2>
        <div>
            {{ generate_namespace_info(T) }}
        </div>
        <script>
            function showCollapse(collapse) {
                collapse.classList.add("show");
                if (collapse.parentNode != null && collapse.classList.contains("collapse")) {
                    showCollapse(collapse.parentNode);
                }
            }

            if (window.location.hash != null && window.location.hash != "") {
                const collapse = document.querySelector(window.location.hash);
                showCollapse(collapse);
                collapse.classList.add("highlight");
                setTimeout(function() {
                    collapse.classList.remove("highlight");
                }, 2000);
            } else {
                const collapse = document.querySelector("#uavcan");
                showCollapse(collapse);
            }

            window.onhashchange = function() {
                if (window.location.hash != null && window.location.hash != "") {
                    const collapse = document.querySelector(window.location.hash);
                    showCollapse(collapse);
                    collapse.classList.add("highlight");
                    setTimeout(function() {
                        collapse.classList.remove("highlight");
                    }, 2000);
                }
            }
        </script>
    </body>
</html>
